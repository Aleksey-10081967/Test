Работы по перенастройке клатера Patroni КИС УПД

Этап 1.

        1.1. Останавливаем на каждой bp 3-х node кластера patroni последовательно следующие сервисы:

            systemctl stop vip-manager.service
            systemctl stop patroni,service

        1.2. После остановки указанных выше сервисов останавливаем на 3-х node сервис etcd.

            systemctl stop etcd.service

        1.3. Делаем backup БД etcd, etcd.conf, patroni.yml и vip-manager.yml на каждой из 3-х node.

            cp -r /var/lib/etcd/member /var/lib/etcd/member-bk
            cp /etc/etcd/etcd.conf /etc/etcd/etcd.conf.bk
            cp /etc/patroni/patroni.yml /etc/patroni/patroni.yml.bk

        1.4. Переименовываем на каждой из 3-х node файл etcd.conf в etcd.yml

            mv /etc/ectd/etcd.conf /etc/etcd/etcd.yml

        1.5. Вносим изменение в файл /etc/systemd/system/etcd.service на каждой из 3-х node

            Вместо строки: ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.conf

            Размещаем строку: ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.yml

        1.6. Перечитываем файлы service на каждой из 3-х node

            systemctl daemon-reload

        1.7. Запускаем сервис etcd.service на каждой из 3-х node

            systemctl start etcd.service

Этап 2. Переконфигурирование clients URLS и peer-URLS на 3-x node кластера etcd.

        2.1. Выполнение изменений на первой node (IP - 10.7.7.133)

                2.1.1. Определяем ID_member кластера на котором будем менять URL peer:

                    /usr/local/bin/etcdctl endpoint status --cluster -w table

                2.1.2 Изменение  peer URL.

                    /usr/local/bin/etcdctl member update ID_member --peer-urls=http://10.7.251.117:2380

                2.1.3 Изменение в etcd.yml параметры initial-advertise-peer-urls, listen-peer-urls,initial-cluster,listen-client-urls,advertise-client-urls:

                    listen-client-urls:
                    advertise-client-urls:
                    initial-advertise-peer-urls:
                    listen-peer-urls,initial-cluster:


        2.2. Выполнение изменений на первой node (IP - 10.7.7.134)

                2.2.1. Определяем ID_member кластера на котором будем менять URL peer:

                    /usr/local/bin/etcdctl endpoint status --cluster -w table

                2.2.2 Изменение  peer URL.

                    /usr/local/bin/etcdctl member update ID_member --peer-urls=http://10.7.251.117:2380

                2.2.3 Изменение в etcd.yml параметры initial-advertise-peer-urls, listen-peer-urls,initial-cluster,listen-client-urls,advertise-client-urls:

                    listen-client-urls:
                    advertise-client-urls:
                    initial-advertise-peer-urls:
                    listen-peer-urls,initial-cluster:


        2.3. Выполнение изменений на первой node (IP - 10.7.7.134)

                2.3.1. Определяем ID_member кластера на котором будем менять URL peer:

                    /usr/local/bin/etcdctl endpoint status --cluster -w table

                2.3.2 Изменение  peer URL.

                    /usr/local/bin/etcdctl member update ID_member --peer-urls=http://10.7.251.117:2380

                2.3.3 Изменение в etcd.yml параметры initial-advertise-peer-urls, listen-peer-urls,initial-cluster,listen-client-urls,advertise-client-urls:

                    listen-client-urls:
                    advertise-client-urls:
                    initial-advertise-peer-urls:
                    listen-peer-urls,initial-cluster:

        2.4. Выполняем перезапуск сервиса etcd на каждой node b проверка работы кластера etcd.
            
                systemctl restart etcd.service


Этап 3. Настройка и запуск сервиса patroni.service

    3.1. Внесение изменений в файл /etc/patroni/patroni.yml на 3-х node кластера patroni.

            Вместо строки: 

            Размещаем строку: 

    3.2. После внесения изменений запускаем последовательно на 3-х node patroni.service.

ВНИМАНИЕ: Запуск начинаем с node которая была leader перед остановкой.

        systemctl start patroni.service

    3.3. Проверяем работу кластера patroni совместно скластером etcd



Этап 4. Настройка и запуск сервиса сервиса vip-manager.service

 4.1. Внесение изменений в файл /etc/default/vip-manager.yml на 3-х node кластера patroni.

            Вместо строки: 

            Размещаем строку: 

4.2. Запуск сервиса vip-manager.service на 3-х node кластера patroni
    
        systemctl start vip-manager.service

Этап 5. Проверка работоспособности кластера Patroni.
