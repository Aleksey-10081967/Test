Описание стенда.
Кластер Patroni
    redoc-pgs01 - 192.168.122.170
    redoc-pgs02 - 192.168.122.171
    На обоих node patroni - установлен VIP-manager.service - IP - 192.168.122.201
    
Кластер etcd
    astra-etcd01 - 192.168.122.165
    astra-etcd02 - 192.168.122.166
    astra-etcd03 - 192.168.122.167

    redoc-nfs - сервер nfs который предоставляет общий каталог для redoc-pgs01 и redoc-pgs02 в котором размещен archivelogs для хранения archive wal - 192.168.122.190

    redoc-pgs01-stl - ВМ с клиентским ПО postgresql для подключения к кластеру patroni - 192.168.122.172

Строка подключения - /opt/pgpro/ent-13/bin/psql -h 192.168.122.201 -p 5433 -Upostgres

Дополнительно:
    debian-zabbix-6 - ВМ с Zabbix Server 6.0 - 192.168.122.110
    Агенты zabbix установлены на всех ВМ стенда для сбора данных в БД zabbix


БД развернутые в кластере:

       Имя        |   Владелец   | Кодировка |   LC_COLLATE    |  LC_CTYPE   |     Права доступа     
------------------+--------------+-----------+-----------------+-------------+-----------------------
 backupdb         | postgres     | UTF8      | ru_RU.UTF-8@icu | ru_RU.UTF-8 | 
 data_test        | postgres     | UTF8      | ru_RU.UTF-8@icu | ru_RU.UTF-8 | 
 mamonsu_database | mamonsu_user | UTF8      | ru_RU.UTF-8@icu | ru_RU.UTF-8 | 
 postgres         | postgres     | UTF8      | ru_RU.UTF-8@icu | ru_RU.UTF-8 | 
 template0        | postgres     | UTF8      | ru_RU.UTF-8@icu | ru_RU.UTF-8 | =c/postgres          +
                  |              |           |                 |             | postgres=CTc/postgres
 template1        | postgres     | UTF8      | ru_RU.UTF-8@icu | ru_RU.UTF-8 | =c/postgres          +
                  |              |           |                 |             | postgres=CTc/postgres
 zabbix           | zabbix       | UTF8      | ru_RU.UTF-8@icu | ru_RU.UTF-8 | 


ПЕРЕД  НАЧАЛОМ ТЕСТРИРОВАНИЯ ВОССТАНОВЛЕНИЯ КЛАСТЕРА PATRONI:

1. Cоздан на nfs шаре каталог /mnt/backups_full/archivelogs/. Данный каталог доступен с 2-х node patroni (redoc-pgs01 и redoc-pgs02)

2. В конфиг Patroni (patronctl -c /etc/patroni/patroni.yml edit-config) добавлены следующие парамерты:
    
    archive_mode: 'on'
    archive_command: test ! -f /mnt/backups_full/archivelogs/%f && cp %p /mnt/backups_full/archivelogs/%f
    archive_timeout: 600

3. Выполнен restart node кластера Patroni
    patronctl -c /etc/patroni/patroni.yml cluster-ent13 
    
Контур готов к проведению теста.  

#########################

ВАРИАНТ 1. 
Создание файлового backup c Leader (redos-pgs01) и восстановление из данного backup c archivelogs, сохранненных в общую папку + WAL на redos-pgs01 после 4 переключений между redos-pgs01 - redos-pgs02.


1. Делаем full backup c redos-pgs01 (Leader) c помощью pg_basebackup  

/opt/pgpro/ent-13/bin/pg_basebackup -P -R -Xstream --checkpoint=fast -h localhost -p 5433 -U replicator -D /mnt/backups_full/pg_basebackup_pgs01


2. Перед началом выполнения переключений (swithover) в таблицу my_table БД data_test добавляем 3 записи

   Выполняем 4 swicthover
    patronictl -c /etc/patroni/patroni.yml  switchover cluster-ent13 --master redoc-pgs01  --candidate redoc-pgs02 --force 
    
Внимание: Перед выполнением команды правильно указываем --master и -candidate    

3. После каждого swithover добавляем 3 записи в таблицу my_table БД data_test


4. В итоге имеем 

    id  |                             info                              |            date            
    -----+---------------------------------------------------------------+----------------------------
    425 | 1  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:38.468496
    426 | 2  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:48.021464
    427 | 3  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:54.918321
    
    458 | 4  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:26.222574
    459 | 5  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:33.799444
    460 | 6  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:40.936112
    
    491 | 7  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:10.018219
    492 | 8  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:19.779272
    493 | 9  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:27.876195
    
    524 | 10  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:02:47.205317
    525 | 11  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:02:54.245995
    526 | 12  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:03:03.799033
    
    557 | 13  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:14.674332
    558 | 14  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:23.499151
    559 | 15  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:30.412142
    560 | GAME IS OVER :archive_mode - on, Leader - redoc-pgs01,TL - 80 | 2022-06-01 10:08:49.566131
    (16 строк)

5. Останавливаем на redos-pgs01 и redos-pgs02 сервис patroni
    sudo systemctl stop patroni.service

6.  На redos-pgs01. Переносим папку /pgstore/data в другой каталог /mnt/backups_full/redoc_pgs01/ (данное действие для отката)
    cp -r /pgstore/data /mnt/backups_full/redoc_pgs01/
    
7. На redos-pgs01. Удаляем данные  из папки /pgstore/data
    rm -rf /pgstore/data/*
    
8. На redos-pgs02. Переносим папку /pgstore/data в другой каталог /mnt/backups_full/redoc_pgs02/ (данное действие для отката)
    cp -r /pgstore/data /mnt/backups_full/redoc_pgs02/
    
9. На redos-pgs02. Удаляем данные из папки /pgstore/data
    rm -rf /pgstore/data/*

    
10. На redos-pgs01.  Выполняем подготовленный скрипт (script_backup.sh). 

                    #!/bin/bash
                    
            # Копируем файловый backup созданный в п.1 в каталог кластера 
                    cp -r /mnt/backups_full/pg_basebackup_pgs01/* ./
                    
            # Очищаем каталог pg_wal перенесенного backup.         
                    cd pg_wal/
                    rm -rf *
                    
            # Переносим все WAL файлы с каталог WAL из ранее перенесенного экземпляра кластера (п. 6)        
                    cp -r /mnt/backups_full/redoc_pgs01/data/pg_wal/* ./
                    
            # Создаем файл recovery.signal        
                    touch /pgstore/data/recovery.signal
                    
            # Добавляем строки в postgresql.auto.conf для выполнения процедуры восстановления.

                    echo "recovery_target_timeline = 'latest'" >> /pgstore/data/postgresql.auto.conf
                    echo "restore_command = 'cp /mnt/backups_full/archivelogs/%f %p'" >> /pgstore/data/postgresql.auto.conf
                    echo "recovery_target_action = 'promote'" >> /pgstore/data/postgresql.auto.conf
                    #echo "recovery_target_time = '2022-05-24 13:51:00'" >> /pgstore/data/postgresql.auto.conf

                    chown -R postgres:postgres /pgstore/data
                    chmod -R 700  /pgstore/data

                    rm -rf /var/log/postgresql/*

11. Выполняем запуск инстанса postgresql (не patroni) для накатки archivewal и wal на БД на redos-pgs01.

    /opt/pgpro/ent-13/bin/pg_ctl -D /pgstore/data/ start
    
    [postgres@redoc-pgs01 ~]$ /opt/pgpro/ent-13/bin/pg_ctl -D /pgstore/data/ start
        ожидание запуска сервера....2022-06-01 10:39:09 MSK [9588]: [1-1] db=,user=,app=,client= INFO:  the server was compiled with the ICU library 60.3.0.0
        2022-06-01 10:39:09 MSK [9588]: [2-1] db=,user=,app=,client= INFO:  the database cluster was initialized with the ICU library 60.3.0.0
        2022-06-01 10:39:10 MSK [9588]: [3-1] db=,user=,app=,client= LOG:  Start CFS version 0.54 supported compression algorithms pglz,zlib,lz4,zstd encryption disabled GC enabled
        2022-06-01 10:39:10 MSK [9588]: [4-1] db=,user=,app=,client= LOG:  redirecting log output to logging collector process
        2022-06-01 10:39:10 MSK [9588]: [5-1] db=,user=,app=,client= HINT:  Future log output will appear in directory "/var/log/postgresql".
        готово
        сервер запущен

12. Останавливаем инстанс postgresql на redos-pgs01.
    /opt/pgpro/ent-13/bin/pg_ctl -D /pgstore/data/ stop   
    
13. Перед запуском patroni необходимо информацию об инициализации кластера удалить из etcd.
    Для этого выполняем следующую команду.
    
    patronictl -c /etc/patroni/patroni.yml remove cluster-ent13
    
    + Cluster: cluster-ent13 (7083735782847798515) -+
    | Member | Host | Role | State | TL | Lag in MB |
    +--------+------+------+-------+----+-----------+
    +--------+------+------+-------+----+-----------+
    Please confirm the cluster name to remove: cluster-ent13
    
    Внимательно читаем строку и правильно вводим фразу.
    
    You are about to remove all information in DCS for cluster-ent13, please type: "Yes I am aware": Yes I am aware

14. Проверяем
    patronictl -c /etc/patroni/patroni.yml list
    + Cluster: cluster-ent13 (uninitialized) -------+
    | Member | Host | Role | State | TL | Lag in MB |
    +--------+------+------+-------+----+-----------+
    +--------+------+------+-------+----+-----------+

15. Запускаем серис patroni где восстановили кластер на redos-pgs01.
        sudo systemctl start patroni.service 
        [root@redoc-pgs01 redoc_pgs01]# systemctl status patroni.service  
        ● patroni.service - Runners to orchestrate a high-availability PostgreSQL
            Loaded: loaded (/etc/systemd/system/patroni.service; enabled; vendor preset: disabled)
            Active: active (running) since Wed 2022-06-01 10:39:52 MSK; 5s ago
        Main PID: 9662 (patroni)
            Tasks: 19 (limit: 9499)
            Memory: 177.2M
                CPU: 497ms
            CGroup: /system.slice/patroni.service
                    ├─9662 /usr/bin/python2 /usr/bin/patroni /etc/patroni/patroni.yml
                    ├─9678 /opt/pgpro/ent-13/bin/postgres -D /pgstore/data --config-file=/pgstore/data/postgresql.conf --listen_addresses=0.0.0.0 --max_worker_processes=8 --max_prepared_transactions=0 --wal_level=replica --track_commit_timest
                    ├─9680 postgres: cluster-ent13: logger
                    ├─9682 postgres: cluster-ent13: checkpointer
                    ├─9683 postgres: cluster-ent13: background writer
                    ├─9684 postgres: cluster-ent13: stats collector
                    ├─9685 postgres: cluster-ent13: pg_wait_sampling collector
                    ├─9688 postgres: cluster-ent13: cfs-worker-0
                    ├─9691 postgres: cluster-ent13: postgres postgres 127.0.0.1(54862) idle
                    ├─9696 postgres: cluster-ent13: walwriter
                    ├─9697 postgres: cluster-ent13: autovacuum launcher
                    ├─9698 postgres: cluster-ent13: archiver last was 0000005100000001000000E3.partial
                    ├─9699 postgres: cluster-ent13: logical replication launcher
                    ├─9709 postgres: cluster-ent13: mamonsu_user mamonsu_database 127.0.0.1(54866) idle
                    └─9710 postgres: cluster-ent13: mamonsu_user postgres 127.0.0.1(54868) idle

        июн 01 10:39:52 redoc-pgs01 patroni[9678]: 2022-06-01 10:39:52 MSK [9678]: [4-1] db=,user=,app=,client= LOG:  redirecting log output to logging collector process
        июн 01 10:39:52 redoc-pgs01 patroni[9678]: 2022-06-01 10:39:52 MSK [9678]: [5-1] db=,user=,app=,client= HINT:  Future log output will appear in directory "/var/log/postgresql".
        июн 01 10:39:53 redoc-pgs01 patroni[9686]: localhost:5433 - принимает подключения
        июн 01 10:39:53 redoc-pgs01 patroni[9689]: localhost:5433 - принимает подключения
        июн 01 10:39:53 redoc-pgs01 patroni[9662]: 2022-06-01 10:39:53,624 INFO: establishing a new patroni connection to the postgres cluster
        июн 01 10:39:53 redoc-pgs01 patroni[9662]: 2022-06-01 10:39:53,641 WARNING: Could not activate Linux watchdog device: "Can't open watchdog device: [Errno 2] No such file or directory: '/dev/watchdog'"
        июн 01 10:39:53 redoc-pgs01 patroni[9662]: 2022-06-01 10:39:53,649 INFO: promoted self to leader by acquiring session lock
        июн 01 10:39:53 redoc-pgs01 patroni[9694]: сервер повышается
        июн 01 10:39:53 redoc-pgs01 patroni[9662]: 2022-06-01 10:39:53,654 INFO: cleared rewind state after becoming the leader
        июн 01 10:39:54 redoc-pgs01 patroni[9662]: 2022-06-01 10:39:54,697 INFO: no action. I am (redoc-pgs01), the leader with the lock

redos-pgs01 становится Leader.

16. Запускаем сервис patroni на redos-pgs02.
17. Проверяем состояние кластера Patroni

        patronictl -c /etc/patroni/patroni.yml list
        + Cluster: cluster-ent13 (7083735782847798515) ------+----+-----------+
        | Member      | Host             | Role    | State   | TL | Lag in MB |
        +-------------+------------------+---------+---------+----+-----------+
        | redoc-pgs01 | redoc-pgs01:5433 | Leader  | running | 82 |           |
        | redoc-pgs02 | redoc-pgs02:5433 | Replica | running | 82 |       0.0 |
        +-------------+------------------+---------+---------+----+-----------+

18. Проверяем таблицу my_table БД data_test

        data_test=# select * from my_table;
        id  |                             info                              |            date            
        -----+---------------------------------------------------------------+----------------------------
        425 | 1  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:38.468496
        426 | 2  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:48.021464
        427 | 3  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:54.918321
        458 | 4  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:26.222574
        459 | 5  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:33.799444
        460 | 6  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:40.936112
        491 | 7  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:10.018219
        492 | 8  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:19.779272
        493 | 9  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:27.876195
        524 | 10  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:02:47.205317
        525 | 11  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:02:54.245995
        526 | 12  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:03:03.799033
        557 | 13  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:14.674332
        558 | 14  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:23.499151
        559 | 15  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:30.412142
        560 | GAME IS OVER :archive_mode - on, Leader - redoc-pgs01,TL - 80 | 2022-06-01 10:08:49.566131
        (16 строк)

ДАННЫЕ ВОССТАНОВЛЕНЫ    

19. Дополнительно выполняем проверку работы Zabbix.
    Сервис работает.
    

    
    
ВАРИАНТ 2. 

Создание файлового backup c Replica (redos-pgs01) и восстановление из данного backup c archivelogs, сохранненных в общую папку + WAL на redos-pgs02 после 4 переключений между redos-pgs01 - redos-pgs02.


Состояние кластера patroni.

[postgres@redoc-pgs01 pg_basebackup_pgs01]$ patronictl -c /etc/patroni/patroni.yml list
+ Cluster: cluster-ent13 (7083735782847798515) ------+----+-----------+
| Member      | Host             | Role    | State   | TL | Lag in MB |
+-------------+------------------+---------+---------+----+-----------+
| redoc-pgs01 | redoc-pgs01:5433 | Replica | running | 83 |       0.0 |
| redoc-pgs02 | redoc-pgs02:5433 | Leader  | running | 83 |           |
+-------------+------------------+---------+---------+----+-----------+
[postgres@redoc-pgs01 pg_basebackup_pgs01]$ 

Состояние таблицы my_table БД data_test

data_test=# select * from my_table;
 id  |                             info                              |            date            
-----+---------------------------------------------------------------+----------------------------
 425 | 1  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:38.468496
 426 | 2  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:48.021464
 427 | 3  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76    | 2022-06-01 09:55:54.918321
 458 | 4  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:26.222574
 459 | 5  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:33.799444
 460 | 6  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77    | 2022-06-01 09:59:40.936112
 491 | 7  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:10.018219
 492 | 8  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:19.779272
 493 | 9  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78    | 2022-06-01 10:01:27.876195
 524 | 10  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:02:47.205317
 525 | 11  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:02:54.245995
 526 | 12  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79   | 2022-06-01 10:03:03.799033
 557 | 13  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:14.674332
 558 | 14  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:23.499151
 559 | 15  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80   | 2022-06-01 10:08:30.412142
 560 | GAME IS OVER :archive_mode - on, Leader - redoc-pgs01,TL - 80 | 2022-06-01 10:08:49.566131
(16 строк)

 
1. Делаем full backup c redos-pgs01 (Replica) c помощью pg_basebackup  
/opt/pgpro/ent-13/bin/pg_basebackup -P -R -Xstream --checkpoint=fast -h localhost -p 5433 -U replicator -D /mnt/backups_full/pg_basebackup_pgs01
    Пароль: 
    471604/471604 КБ (100%), табличное пространство 1/1

2. Перед началом выполнения переключений (swithover) в таблицу my_table БД data_test добавляем 3 записи

   Выполняем 4 swicthover
    patronictl -c /etc/patroni/patroni.yml  switchover cluster-ent13 --master redoc-pgs01  --candidate redoc-pgs02 --force 
    
Внимание: Перед выполнением команды правильно указываем --master и -candidate    

3. После каждого swithover добавляем 3 записи в таблицу my_table БД data_test

4. Имеем перед восстановлением.

Состояние кластера:
        postgres@redoc-pgs01 pg_basebackup_pgs01]$ patronictl -c /etc/patroni/patroni.yml list
        + Cluster: cluster-ent13 (7083735782847798515) ------+----+-----------+
        | Member      | Host             | Role    | State   | TL | Lag in MB |
        +-------------+------------------+---------+---------+----+-----------+
        | redoc-pgs01 | redoc-pgs01:5433 | Replica | running | 87 |       0.0 |
        | redoc-pgs02 | redoc-pgs02:5433 | Leader  | running | 87 |           |
        +-------------+------------------+---------+---------+----+-----------+

Данные в таблице my_table БД data_test 

    data_test=# select * from my_table;
    id  |                                   info                                   |            date            
    -----+--------------------------------------------------------------------------+----------------------------
    425 | 1  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:38.468496
    426 | 2  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:48.021464
    427 | 3  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:54.918321
    458 | 4  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:26.222574
    459 | 5  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:33.799444
    460 | 6  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:40.936112
    491 | 7  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:10.018219
    492 | 8  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:19.779272
    493 | 9  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:27.876195
    524 | 10  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:02:47.205317
    525 | 11  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:02:54.245995
    526 | 12  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:03:03.799033
    557 | 13  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:14.674332
    558 | 14  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:23.499151
    559 | 15  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:30.412142
    560 | GAME IS OVER :archive_mode - on, Leader - redoc-pgs01,TL - 80            | 2022-06-01 10:08:49.566131
    590 | 1 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:11.314706
    591 | 2 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:19.099458
    592 | 3 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:26.884377
    624 | 4 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:44.14929
    625 | 5 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:51.846085
    626 | 6 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:59.343062
    657 | 7 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:17:52.619744
    658 | 8 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:18:01.004633
    659 | 9 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:18:08.90951
    690 | 10 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:26.102532
    691 | 11 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:40.760136
    692 | 12 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:47.91291
    723 | 13 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:37.118338
    724 | 14 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:44.479179
    725 | 15 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:52.984001
    726 | GAME IS OVER  ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87 | 2022-06-01 12:21:14.714537

ВОССТАНОВЛЕНИЕ

5. Останавливаем на redos-pgs01 и redos-pgs02 сервис patroni
    sudo systemctl stop patroni.service

6.  На redos-pgs01. Переносим папку /pgstore/data в другой каталог /mnt/backups_full/redoc_pgs01/ (данное действие для отката)
    cp -r /pgstore/data /mnt/backups_full/redoc_pgs01/
    
7. На redos-pgs01. Удаляем данные  из папки /pgstore/data
    rm -rf /pgstore/data/*
    
8. На redos-pgs02. Переносим папку /pgstore/data в другой каталог /mnt/backups_full/redoc_pgs02/ (данное действие для отката)
    cp -r /pgstore/data /mnt/backups_full/redoc_pgs02/
    
9. На redos-pgs02. Удаляем данные из папки /pgstore/data
    rm -rf /pgstore/data/*

    
10. На redos-pgs01.  Выполняем подготовленный скрипт (script_backup.sh). Можно выполнить последовательно команды описанные в скрипте.

                    #!/bin/bash
                    
            # Копируем файловый backup созданный в п.1 в каталог кластера 
                    cp -r /mnt/backups_full/pg_basebackup_pgs01/* ./
                    
            # Очищаем каталог pg_wal перенесенного backup.         
                    cd pg_wal/
                    rm -rf *
                    
            # Переносим все WAL файлы с каталог WAL из ранее перенесенного экземпляра кластера (п. 6)        
                    cp -r /mnt/backups_full/redoc_pgs01/data/pg_wal/* ./
                    
            # Создаем файл recovery.signal        
                    touch /pgstore/data/recovery.signal
                    
            # Добавляем строки в postgresql.auto.conf для выполнения процедуры восстановления.

                    echo "recovery_target_timeline = 'latest'" >> /pgstore/data/postgresql.auto.conf
                    echo "restore_command = 'cp /mnt/backups_full/archivelogs/%f %p'" >> /pgstore/data/postgresql.auto.conf
                    echo "recovery_target_action = 'promote'" >> /pgstore/data/postgresql.auto.conf
                    #echo "recovery_target_time = '2022-05-24 13:51:00'" >> /pgstore/data/postgresql.auto.conf

                    chown -R postgres:postgres /pgstore/data
                    chmod -R 700  /pgstore/data

                    rm -rf /var/log/postgresql/*       
        

11. Выполняем запуск инстанса postgresql (не patroni) для накатки archivewal и wal на БД на redos-pgs01.

        [postgres@redoc-pgs01 data]$ /opt/pgpro/ent-13/bin/pg_ctl -D /pgstore/data/ start
        
        ожидание запуска сервера....2022-06-01 12:37:06 MSK [12138]: [1-1] db=,user=,app=,client= INFO:  the server was compiled with the ICU library 60.3.0.0
        2022-06-01 12:37:06 MSK [12138]: [2-1] db=,user=,app=,client= INFO:  the database cluster was initialized with the ICU library 60.3.0.0
        2022-06-01 12:37:06 MSK [12138]: [3-1] db=,user=,app=,client= LOG:  Start CFS version 0.54 supported compression algorithms pglz,zlib,lz4,zstd encryption disabled GC enabled
        2022-06-01 12:37:06 MSK [12138]: [4-1] db=,user=,app=,client= LOG:  redirecting log output to logging collector process
        2022-06-01 12:37:06 MSK [12138]: [5-1] db=,user=,app=,client= HINT:  Future log output will appear in directory "/var/log/postgresql".
        готово
        сервер запущен

12 Останавливаем инстанс postgresql на redos-pgs01.

        /opt/pgpro/ent-13/bin/pg_ctl -D /pgstore/data/ stop

13. Перед запуском patroni необходимо информацию об инициализации кластера удалить из etcd.
    Для этого выполняем следующую команду.
    
        [root@redoc-pgs01 redoc_pgs01]# patronictl -c /etc/patroni/patroni.yml remove cluster-ent13
        + Cluster: cluster-ent13 (7083735782847798515) -+
        | Member | Host | Role | State | TL | Lag in MB |
        +--------+------+------+-------+----+-----------+
        +--------+------+------+-------+----+-----------+
        Please confirm the cluster name to remove: cluster-ent13
        You are about to remove all information in DCS for cluster-ent13, please type: "Yes I am aware": Yes I am aware


14. на redos-pgs01: 

        sudo systemctl start patroni.service

15. на redos-pgs02: 
        
        sudo systemctl start patroni.service

16. на redos-pgs01: 

        [root@redoc-pgs01 redoc_pgs01]# patronictl -c /etc/patroni/patroni.yml list
        + Cluster: cluster-ent13 (7083735782847798515) ------+----+-----------+
        | Member      | Host             | Role    | State   | TL | Lag in MB |
        +-------------+------------------+---------+---------+----+-----------+
        | redoc-pgs01 | redoc-pgs01:5433 | Leader  | running | 88 |           |
        | redoc-pgs02 | redoc-pgs02:5433 | Replica | running | 88 |       0.0 |
        +-------------+------------------+---------+---------+----+-----------+


17 data_test=# select * from my_table;

        id  |                                   info                                   |            date            
        -----+--------------------------------------------------------------------------+----------------------------
        425 | 1  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:38.468496
        426 | 2  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:48.021464
        427 | 3  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:54.918321
        458 | 4  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:26.222574
        459 | 5  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:33.799444
        460 | 6  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:40.936112
        491 | 7  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:10.018219
        492 | 8  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:19.779272
        493 | 9  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:27.876195
        524 | 10  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:02:47.205317
        525 | 11  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:02:54.245995
        526 | 12  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:03:03.799033
        557 | 13  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:14.674332
        558 | 14  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:23.499151
        559 | 15  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:30.412142
        560 | GAME IS OVER :archive_mode - on, Leader - redoc-pgs01,TL - 80            | 2022-06-01 10:08:49.566131
        590 | 1 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:11.314706
        591 | 2 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:19.099458
        592 | 3 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:26.884377
        624 | 4 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:44.14929
        625 | 5 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:51.846085
        626 | 6 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:59.343062
        657 | 7 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:17:52.619744
        658 | 8 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:18:01.004633
        659 | 9 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:18:08.90951
        690 | 10 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:26.102532
        691 | 11 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:40.760136
        692 | 12 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:47.91291
        723 | 13 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:37.118338
        724 | 14 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:44.479179
        725 | 15 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:52.984001
        726 | GAME IS OVER  ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87 | 2022-06-01 12:21:14.714537
        (32 строки)

ДАННЫЕ ВОССТАНОВЛЕНЫ


Вариант 3. Восстановление без копирования WAL c leader (redoc-pgs02)

Выполняем п.5 - п.9 Варианта 2
п.10
В скрипте (script_backup.sh) на redos-pgs01 комментируем строку 

#cp -r /mnt/backups_full/redoc_pgs02/data/pg_wal/* ./

и Выполняем скрипт.

далее все остальные п.11 - п.16. Варианта 2
п.17
data_test=# select * from my_table;
 id  |                                   info                                   |            date            
-----+--------------------------------------------------------------------------+----------------------------
 425 | 1  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:38.468496
 426 | 2  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:48.021464
 427 | 3  запись :archive_mode - on, Leader - redoc-pgs01,TL - 76               | 2022-06-01 09:55:54.918321
 458 | 4  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:26.222574
 459 | 5  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:33.799444
 460 | 6  запись :archive_mode - on, Leader - redoc-pgs02,TL - 77               | 2022-06-01 09:59:40.936112
 491 | 7  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:10.018219
 492 | 8  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:19.779272
 493 | 9  запись :archive_mode - on, Leader - redoc-pgs01,TL - 78               | 2022-06-01 10:01:27.876195
 524 | 10  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:02:47.205317
 525 | 11  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:02:54.245995
 526 | 12  запись :archive_mode - on, Leader - redoc-pgs02,TL - 79              | 2022-06-01 10:03:03.799033
 557 | 13  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:14.674332
 558 | 14  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:23.499151
 559 | 15  запись :archive_mode - on, Leader - redoc-pgs01,TL - 80              | 2022-06-01 10:08:30.412142
 560 | GAME IS OVER :archive_mode - on, Leader - redoc-pgs01,TL - 80            | 2022-06-01 10:08:49.566131
 590 | 1 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:11.314706
 591 | 2 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:19.099458
 592 | 3 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 83      | 2022-06-01 12:14:26.884377
 624 | 4 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:44.14929
 625 | 5 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:51.846085
 626 | 6 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 84      | 2022-06-01 12:15:59.343062
 657 | 7 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:17:52.619744
 658 | 8 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:18:01.004633
 659 | 9 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 85      | 2022-06-01 12:18:08.90951
 690 | 10 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:26.102532
 691 | 11 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:40.760136
 692 | 12 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs01,TL - 86     | 2022-06-01 12:19:47.91291
 723 | 13 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:37.118338
 724 | 14 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:44.479179
 725 | 15 запись ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87     | 2022-06-01 12:20:52.984001
 726 | GAME IS OVER  ВАРИАНТ 2 :archive_mode - on, Leader - redoc-pgs02,TL - 87 | 2022-06-01 12:21:14.714537

ДАННЫЕ ВОСТАНОВЛЕНЫ.

При внесении изменений в БД кластера patroni и после остановки сервисов patroni.service сначала на Replica, потом на Leader выполняется сбор wal в archivelog. 
Это косвенно подтверждено появление доп файла в archivelog после остановки сервисов patroni и сообветсвенно postgresql.














 
 








 
 
 
